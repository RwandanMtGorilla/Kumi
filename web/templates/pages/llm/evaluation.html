{% extends "base.html" %}

{% block title %}
æµ‹è¯„ä»»åŠ¡ - Kumi
{% endblock %}

{% block content %}
<div class="container-fluid">
    <!-- äºŒçº§å¯¼èˆªæ  -->
    <div class="row mb-4">
        <div class="col-12">
            <nav class="nav nav-pills justify-content-center">
                <a class="nav-link" href="/web/llm/config" data-page="config">é…ç½®è¢«æµ‹å¤§æ¨¡å‹</a>
                <a class="nav-link" href="/web/llm/upload-dataset" data-page="dataset">ä¸Šä¼ æµ‹è¯„é›†</a>
                <a class="nav-link" href="/web/llm/upload-rules" data-page="rules">åˆ›å»ºæµ‹è¯„è§„åˆ™</a>
                <a class="nav-link active" href="/web/llm/evaluation" data-page="evaluation">æµ‹è¯„ä»»åŠ¡</a>
            </nav>
        </div>
    </div>

    <!-- ä¸»ä½“å†…å®¹ -->
    <div class="row justify-content-center">
        <div class="col-12 col-xl-10">
            <div class="card">
                <div class="card-body">
                    <div class="d-flex justify-content-between align-items-center mb-4">
                        <h5 class="card-title mb-0 text-primary">æµ‹è¯„ç»“æœæ–‡ä»¶</h5>
                        <button type="button" class="btn btn-gradient-primary" onclick="showCreateTaskModal()">
                            <i class="bi bi-plus-circle"></i> åˆ›å»ºæµ‹è¯„ä»»åŠ¡
                        </button>
                    </div>

                    <!-- ç»“æœè¡¨æ ¼ -->
                    <div class="table-responsive">
                        <table class="table table-hover" id="resultsTable">
                            <thead class="table-light"> {# æ·»åŠ  class="table-light" #}
                                <tr>
                                    <th>æ–‡ä»¶å</th>
                                    <th>ç”Ÿæˆæ—¶é—´</th>
                                    <th>ç±»å‹</th>
                                    <th>å¤§å°</th>
                                    <th>æ“ä½œ</th>
                                </tr>
                            </thead>
                            <tbody>
                                <!-- æ•°æ®å°†é€šè¿‡JavaScriptåŠ¨æ€åŠ è½½ -->
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- åˆ›å»ºä»»åŠ¡æ¨¡æ€æ¡† -->
<div class="modal fade" id="createTaskModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">åˆ›å»ºæµ‹è¯„ä»»åŠ¡</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <!-- ä»»åŠ¡ç±»å‹é€‰æ‹© -->
                <div class="mb-4">
                    <label class="form-label">é€‰æ‹©ä»»åŠ¡ç±»å‹</label>
                    <div class="row">
                        <div class="col-md-6">
                            <div class="task-type-card" onclick="selectTaskType('test')">
                                <div class="task-type-icon">ğŸ§ª</div>
                                <h6>æµ‹è¯„ä»»åŠ¡</h6>
                                <p class="text-muted small">ä½¿ç”¨å¤§æ¨¡å‹å¤„ç†æ•°æ®é›†ï¼Œç”Ÿæˆå›ç­”ç»“æœ</p>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="task-type-card" onclick="selectTaskType('evaluation')">
                                <div class="task-type-icon">ğŸ“Š</div>
                                <h6>è¯„ä»·ä»»åŠ¡</h6>
                                <p class="text-muted small">ä½¿ç”¨è¯„ä»·è§„åˆ™å¯¹æµ‹è¯„ç»“æœè¿›è¡Œè¯„åˆ†</p>
                            </div>
                        </div>
                    </div>
                </div>
                <!-- é€šç”¨é…ç½® -->
                <div id="commonConfig" style="display:none;">
                    <div class="mb-3">
                        <label class="form-label">å¹¶å‘æ•°</label>
                        <div class="row">
                            <div class="col-md-8">
                                <input type="range" class="form-range" id="maxWorkersRange"
                                       min="1" max="20" value="5"
                                       oninput="updateWorkersValue(this.value)">
                            </div>
                            <div class="col-md-4">
                                <div class="input-group">
                                    <input type="number" class="form-control" id="maxWorkersInput"
                                           min="1" max="20" value="5"
                                           onchange="updateWorkersRange(this.value)">
                                    <span class="input-group-text">çº¿ç¨‹</span>
                                </div>
                            </div>
                        </div>
                        <div class="form-text">
                            <i class="bi bi-info-circle"></i>
                            å¹¶å‘æ•°è¶Šé«˜å¤„ç†é€Ÿåº¦è¶Šå¿«ï¼Œä½†ä¼šå¢åŠ APIæœåŠ¡å™¨å‹åŠ›ã€‚æµ‹è¯„ä»»åŠ¡å»ºè®®5-10ï¼Œè¯„ä»·ä»»åŠ¡å»ºè®®1-5ã€‚
                        </div>
                    </div>
                </div>

                <!-- æµ‹è¯„ä»»åŠ¡é…ç½® -->
                <div id="testTaskConfig" class="task-config" style="display:none;">
                    <div class="mb-3">
                        <label class="form-label">é€‰æ‹©è¢«æµ‹å¤§æ¨¡å‹</label>
                        <select class="form-select" id="modelSelect">
                            <option value="">è¯·é€‰æ‹©æ¨¡å‹...</option>
                        </select>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">é€‰æ‹©æ•°æ®é›†</label>
                        <select class="form-select" id="datasetSelect">
                            <option value="">è¯·é€‰æ‹©æ•°æ®é›†...</option>
                        </select>
                    </div>
                </div>

                <!-- è¯„ä»·ä»»åŠ¡é…ç½® -->
                <div id="evaluationTaskConfig" class="task-config" style="display:none;">
                    <div class="mb-3">
                        <label class="form-label">é€‰æ‹©è¯„ä»·è§„åˆ™</label>
                        <select class="form-select" id="ruleSelect">
                            <option value="">è¯·é€‰æ‹©è¯„ä»·è§„åˆ™...</option>
                        </select>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">é€‰æ‹©æµ‹è¯„ç»“æœæ–‡ä»¶</label>
                        <select class="form-select" id="resultFileSelect">
                            <option value="">è¯·é€‰æ‹©æµ‹è¯„ç»“æœæ–‡ä»¶...</option>
                        </select>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">å–æ¶ˆ</button>
                <button type="button" class="btn btn-gradient-primary" onclick="startTask()" id="startTaskBtn" disabled> {# ä¿®æ”¹æŒ‰é’®ç±» #}
                    å¼€å§‹æ‰§è¡Œ
                </button>
            </div>
        </div>
    </div>
</div>

<!-- è¿›åº¦æ¨¡æ€æ¡† -->
<div class="modal fade" id="progressModal" tabindex="-1" data-bs-backdrop="static">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">ä»»åŠ¡æ‰§è¡Œä¸­</h5>
            </div>
            <div class="modal-body text-center">
                <div class="progress mb-3" style="height: 20px;">
                    <div class="progress-bar progress-bar-striped progress-bar-animated"
                         id="taskProgress"
                         role="progressbar"
                         style="width: 0%"></div>
                </div>
                <div id="progressMessage">ä»»åŠ¡å‡†å¤‡ä¸­...</div>
                <div class="mt-3">
                    <small class="text-muted" id="progressDetails">æ­¥éª¤: 0/0</small>
                </div>
                <!-- æ–°å¢é¢„ä¼°æ—¶é—´æ˜¾ç¤º -->
                <div class="mt-2">
                    <small class="text-info" id="estimatedTime" style="display:none;">
                        <i class="bi bi-clock"></i> é¢„ä¼°å‰©ä½™æ—¶é—´: <span id="estimatedTimeValue">--</span> {# ä¿®æ”¹å›¾æ ‡ç±» #}
                    </small>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-gradient-primary" onclick="closeProgressModal()" disabled id="closeProgressBtn"> {# ä¿®æ”¹æŒ‰é’®ç±» #}
                    å…³é—­
                </button>
            </div>
        </div>
    </div>
</div>

<style>
/* ä¸ä¸Šä¼ æµ‹è¯„é›†é¡µé¢ä¿æŒä¸€è‡´çš„äºŒçº§å¯¼èˆªæ æ ·å¼ */
.nav-pills .nav-link.active {
    background: linear-gradient(135deg, var(--primary-gradient-start) 0%, var(--primary-gradient-end) 100%);
    color: white !important;
    border: none;
    box-shadow: 0 4px 12px rgba(102, 102, 255, 0.3); /* ä¸å¼ºè°ƒè‰²ä¿æŒä¸€è‡´çš„é˜´å½± */
    font-weight: 600; /* æ¿€æ´»çŠ¶æ€çš„å­—ä½“åŠ ç²— */
}

.nav-pills .nav-link {
    color: var(--primary-color); /* å¼ºè°ƒè‰² */
    margin: 0 10px;
    font-weight: 500;
    transition: all 0.3s ease;
}

.nav-pills .nav-link:hover {
    background: linear-gradient(135deg, rgba(170, 169, 255, 0.2) 0%, rgba(181, 213, 255, 0.2) 100%); /* æµ…è‰²é€æ˜æ¸å˜æ‚¬åœæ•ˆæœ */
    color: var(--primary-dark); /* æ‚¬åœæ—¶é¢œè‰²å˜æ·± */
}

/* å¢åŠ ä¸»ä½“å†…å®¹çš„è¾¹è· */
.container-fluid {
    padding-left: 2rem;
    padding-right: 2rem;
}

@media (max-width: 768px) {
    .container-fluid {
        padding-left: 1rem;
        padding-right: 1rem;
    }
}

/* ç¡®ä¿å¡ç‰‡æ ‡é¢˜æ ·å¼ä¸€è‡´ */
.card-title {
    font-size: 1.25rem;
    font-weight: 600;
}


/* è‡ªå®šä¹‰æ¸å˜æŒ‰é’®ç±»ï¼Œä¸ä¹‹å‰é¡µé¢ä¿æŒä¸€è‡´ */
.btn-gradient-primary {
    background: linear-gradient(135deg, var(--primary-gradient-start) 0%, var(--primary-gradient-end) 100%) !important;
    color: white !important;
    border: none !important;
    font-weight: 600 !important;
    padding: 0.625rem 1.5rem !important; /* ç»Ÿä¸€å†…è¾¹è· */
    border-radius: 0.5rem !important; /* ç»Ÿä¸€åœ†è§’ */
    transition: all 0.3s ease !important;
    box-shadow: 0 4px 12px rgba(102, 102, 255, 0.3) !important; /* ç»Ÿä¸€é˜´å½± */
}

.btn-gradient-primary:hover {
    transform: translateY(-2px) !important;
    box-shadow: 0 8px 24px rgba(102, 102, 255, 0.4) !important;
    background: linear-gradient(135deg, var(--primary-dark) 0%, var(--primary-color) 100%) !important; /* æ‚¬åœæ—¶æ¸å˜ç•¥å¾®è°ƒæ•´ä»¥å¢åŠ æ·±åº¦ */
}

/* è¡¨æ ¼æ ·å¼ */
.table {
    border-collapse: separate; /* å…è®¸è¡¨æ ¼åœ†è§’ */
    border-spacing: 0;
    border-radius: 0.75rem; /* æŸ”åŒ–è¡¨æ ¼è¾¹è§’ */
    overflow: hidden; /* ç¡®ä¿åœ†è§’å¯è§ */
    box-shadow: var(--shadow-sm); /* è¡¨æ ¼çš„å¾®å¦™é˜´å½± */
}

.table-responsive {
    border-radius: 0.75rem; /* å“åº”å¼å®¹å™¨ä¹Ÿåº”ç”¨åœ†è§’ */
    overflow: hidden; /* ç¡®ä¿å†…éƒ¨è¡¨æ ¼çš„åœ†è§’å¯è§ */
}

.table-light {
    background-color: var(--gray-100) !important; /* è¡¨æ ¼å¤´éƒ¨çš„æµ…ç°è‰² */
}

.table thead th {
    color: var(--gray-600); /* è¡¨æ ¼å¤´éƒ¨æ·±è‰²æ–‡æœ¬ */
    font-weight: 600;
    padding: 0.75rem 1.25rem; /* è°ƒæ•´å†…è¾¹è· */
    border-top: none; /* ç§»é™¤é¡¶éƒ¨è¾¹æ¡† */
}

.table tbody td {
    color: var(--gray-700); /* è¡¨æ ¼å•å…ƒæ ¼ä¸»æ–‡æœ¬é¢œè‰² */
    padding: 0.75rem 1.25rem; /* è°ƒæ•´å†…è¾¹è· */
    vertical-align: middle;
}

.table-hover tbody tr:hover {
    background-color: rgba(102, 102, 255, 0.05); /* è¡¨æ ¼è¡Œæµ…è‰²æ‚¬åœæ•ˆæœ */
}

/* æè¾¹æŒ‰é’®æ ·å¼ */
.btn-outline-primary {
    color: var(--primary-color);
    border-color: var(--primary-color);
    transition: all 0.2s ease;
}

.btn-outline-primary:hover {
    background-color: var(--primary-color);
    color: var(--white) !important;
    box-shadow: var(--shadow-sm);
    transform: translateY(-1px);
}

.btn-outline-danger {
    color: #FF6B6B; /* ä¸ä¹‹å‰é¡µé¢åˆ é™¤æŒ‰é’®ä¸€è‡´çš„çº¢è‰² */
    border-color: #FF6B6B;
    transition: all 0.2s ease;
}

.btn-outline-danger:hover {
    background-color: #FF6B6B;
    color: var(--white) !important;
    box-shadow: var(--shadow-sm);
    transform: translateY(-1px);
}

/* å¡ç‰‡æ ·å¼ */
.card {
    border-radius: 0.75rem !important; /* ç»Ÿä¸€å¡ç‰‡åœ†è§’ */
    box-shadow: var(--shadow) !important; /* ç»Ÿä¸€å¡ç‰‡é˜´å½± */
    border: 1px solid var(--gray-200) !important; /* å¡ç‰‡æµ…è‰²è¾¹æ¡† */
}

/* ä»»åŠ¡ç±»å‹å¡ç‰‡æ ·å¼ */
.task-type-card {
    border: 2px solid var(--gray-200); /* ä½¿ç”¨æµ…ç°è‰²è¾¹æ¡† */
    border-radius: 0.75rem; /* ç»Ÿä¸€åœ†è§’ */
    padding: 20px;
    text-align: center;
    cursor: pointer;
    transition: all 0.3s;
    height: 140px;
    display: flex;
    flex-direction: column;
    justify-content: center;
    background-color: var(--white); /* æ˜ç¡®è®¾ç½®ä¸ºç™½è‰²èƒŒæ™¯ */
    box-shadow: var(--shadow-sm); /* å¾®å¦™çš„é˜´å½± */
}

.task-type-card:hover {
    border-color: var(--primary-color); /* æ‚¬åœæ—¶è¾¹æ¡†å˜ä¸ºå¼ºè°ƒè‰² */
    background-color: rgba(102, 102, 255, 0.05); /* é€æ˜å¼ºè°ƒè‰²èƒŒæ™¯æ‚¬åœ */
    box-shadow: 0 2px 8px rgba(102, 102, 255, 0.1); /* æ‚¬åœæ—¶å¾®å¦™é˜´å½± */
    transform: translateY(-2px);
}

.task-type-card.selected {
    border-color: var(--primary-color); /* é€‰ä¸­æ—¶è¾¹æ¡†å˜ä¸ºå¼ºè°ƒè‰² */
    background-color: rgba(102, 102, 255, 0.1); /* é€‰ä¸­æ—¶æ›´æ˜æ˜¾çš„é€æ˜å¼ºè°ƒè‰²èƒŒæ™¯ */
    box-shadow: 0 4px 16px rgba(102, 102, 255, 0.15); /* é€‰ä¸­æ—¶æ›´æ˜æ˜¾çš„é˜´å½± */
}

.task-type-icon {
    font-size: 2.5rem; /* ç•¥å¤§çš„å›¾æ ‡ */
    margin-bottom: 10px;
    color: var(--primary-color); /* å›¾æ ‡é¢œè‰²ä¸å¼ºè°ƒè‰²ä¸€è‡´ */
}

.task-type-card h6 {
    color: var(--gray-700);
    font-weight: 600;
}

.task-config {
    border-top: 1px solid var(--gray-200); /* é…ç½®éƒ¨åˆ†çš„é¡¶éƒ¨è¾¹æ¡† */
    padding-top: 20px;
}

/* è¿›åº¦æ¡æ ·å¼ */
.progress-bar {
    background: linear-gradient(135deg, var(--primary-gradient-start) 0%, var(--primary-gradient-end) 100%);
}

/* ä»»åŠ¡ç±»å‹å¾½ç« æ ·å¼ */
.badge {
    padding: 0.4em 0.7em;
    border-radius: 0.375rem;
    font-size: 0.85em;
    font-weight: 600;
    line-height: 1;
    vertical-align: middle;
    white-space: nowrap;
    text-align: center;
}

.badge-test-type {
    background-color: var(--primary-lighter); /* æµ‹ä»»åŠ¡å¾½ç« èƒŒæ™¯ */
    color: var(--primary-dark); /* æµ‹ä»»åŠ¡å¾½ç« æ–‡æœ¬ */
}

.badge-evaluation-type {
    background-color: var(--gray-200); /* è¯„ä»»åŠ¡å¾½ç« èƒŒæ™¯ */
    color: var(--gray-700); /* è¯„ä»»åŠ¡å¾½ç« æ–‡æœ¬ */
}

/* å…¶ä»–æ ·å¼è°ƒæ•´ï¼Œç¡®ä¿ä¸å…¨å±€æ ·å¼ä¸€è‡´ */
.modal-header .modal-title {
    color: var(--gray-700);
    font-weight: 600;
}

.form-label {
    color: var(--gray-700);
    font-weight: 600;
}

.form-text {
    color: var(--gray-500);
}

.input-group-text {
    background-color: var(--gray-100);
    border-color: var(--gray-300);
    color: var(--gray-600);
}

</style>

<script>
let selectedTaskType = null;
let currentTaskId = null;
let progressInterval = null;

// é¡µé¢åŠ è½½å®Œæˆåæ‰§è¡Œ
document.addEventListener('DOMContentLoaded', function() {
    loadResultsTable();
});

// åŠ è½½ç»“æœè¡¨æ ¼
async function loadResultsTable() {
    try {
        const response = await fetch('/web/api/llm/evaluation/results');
        const data = await response.json();

        if (data.status === 'success') {
            renderResultsTable(data.data);
        } else {
            console.error('åŠ è½½ç»“æœå¤±è´¥:', data);
        }
    } catch (error) {
        console.error('åŠ è½½ç»“æœå¤±è´¥:', error);
    }
}

// æ¸²æŸ“ç»“æœè¡¨æ ¼
function renderResultsTable(results) {
    const tbody = document.querySelector('#resultsTable tbody');
    tbody.innerHTML = '';

    if (results.length === 0) {
        tbody.innerHTML = '<tr><td colspan="5" class="text-center text-muted">æš‚æ— ç»“æœæ–‡ä»¶</td></tr>';
        return;
    }

    results.forEach(result => {
        const row = document.createElement('tr');
        const createdTime = new Date(result.created_time).toLocaleString('zh-CN');
        const fileSize = formatFileSize(result.size);
        // ä¿®æ”¹ä»»åŠ¡ç±»å‹å¾½ç« çš„ç±»å
        const typeClass = result.type === 'æµ‹' ? 'badge-test-type' : 'badge-evaluation-type';

        row.innerHTML = `
            <td>${result.filename}</td>
            <td>${createdTime}</td>
            <td><span class="badge ${typeClass}">${result.type}</span></td> {# ä½¿ç”¨æ–°çš„å¾½ç« ç±» #}
            <td>${fileSize}</td>
            <td>
                <button class="btn btn-outline-primary btn-sm" onclick="downloadFile('${result.filename}')">
                    <i class="bi bi-download"></i> ä¸‹è½½ {# ä¿®æ”¹å›¾æ ‡ç±» #}
                </button>
                <button class="btn btn-outline-danger btn-sm" onclick="deleteFile('${result.filename}')">
                    <i class="bi bi-trash"></i> åˆ é™¤ {# ä¿®æ”¹å›¾æ ‡ç±» #}
                </button>
            </td>
        `;
        tbody.appendChild(row);
    });
}

// æ ¼å¼åŒ–æ–‡ä»¶å¤§å°
function formatFileSize(bytes) {
    if (bytes === 0) return '0 B';
    const k = 1024;
    const sizes = ['B', 'KB', 'MB', 'GB'];
    const i = Math.floor(Math.log(bytes) / Math.log(k));
    return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
}

// æ˜¾ç¤ºåˆ›å»ºä»»åŠ¡æ¨¡æ€æ¡†
async function showCreateTaskModal() {
    selectedTaskType = null;
    document.querySelectorAll('.task-type-card').forEach(card => {
        card.classList.remove('selected');
    });
    document.querySelectorAll('.task-config').forEach(config => {
        config.style.display = 'none';
    });
    document.getElementById('startTaskBtn').disabled = true;

    // åŠ è½½æ•°æ®
    await Promise.all([
        loadModels(),
        loadDatasets(),
        loadRules(),
        loadTempResults()
    ]);

    new bootstrap.Modal(document.getElementById('createTaskModal')).show();
}

// é€‰æ‹©ä»»åŠ¡ç±»å‹
function selectTaskType(type) {
    selectedTaskType = type;

    // æ›´æ–°UI
    document.querySelectorAll('.task-type-card').forEach(card => {
        card.classList.remove('selected');
    });
    event.target.closest('.task-type-card').classList.add('selected');

    // æ˜¾ç¤ºç›¸åº”é…ç½®
    document.querySelectorAll('.task-config').forEach(config => {
        config.style.display = 'none';
    });

    // æ˜¾ç¤ºé€šç”¨é…ç½®
    document.getElementById('commonConfig').style.display = 'block';

    if (type === 'test') {
        document.getElementById('testTaskConfig').style.display = 'block';
        // è®¾ç½®æ¨èå¹¶å‘æ•°
        document.getElementById('maxWorkersRange').value = 8;
        document.getElementById('maxWorkersInput').value = 8;
    } else if (type === 'evaluation') {
        document.getElementById('evaluationTaskConfig').style.display = 'block';
        // è®¾ç½®æ¨èå¹¶å‘æ•°
        document.getElementById('maxWorkersRange').value = 3;
        document.getElementById('maxWorkersInput').value = 3;
    }

    validateForm();
}

// æ›´æ–°å¹¶å‘æ•°å€¼
function updateWorkersValue(value) {
    document.getElementById('maxWorkersInput').value = value;
}

function updateWorkersRange(value) {
    document.getElementById('maxWorkersRange').value = value;
}

// åŠ è½½æ¨¡å‹åˆ—è¡¨
async function loadModels() {
    try {
        const response = await fetch('/web/api/llm/models');
        const data = await response.json();

        const select = document.getElementById('modelSelect');
        select.innerHTML = '<option value="">è¯·é€‰æ‹©æ¨¡å‹...</option>';

        if (data.status === 'success') {
            data.data.forEach(model => {
                const option = document.createElement('option');
                option.value = model.name;
                option.textContent = model.name;
                select.appendChild(option);
            });
        }
    } catch (error) {
        console.error('åŠ è½½æ¨¡å‹åˆ—è¡¨å¤±è´¥:', error);
    }
}

// åŠ è½½æ•°æ®é›†åˆ—è¡¨
async function loadDatasets() {
    try {
        const response = await fetch('/web/api/llm/datasets');
        const data = await response.json();

        const select = document.getElementById('datasetSelect');
        select.innerHTML = '<option value="">è¯·é€‰æ‹©æ•°æ®é›†...</option>';

        if (data.status === 'success') {
            data.data.forEach(dataset => {
                const option = document.createElement('option');
                option.value = dataset.name;
                option.textContent = dataset.name;
                select.appendChild(option);
            });
        }
    } catch (error) {
        console.error('åŠ è½½æ•°æ®é›†åˆ—è¡¨å¤±è´¥:', error);
    }
}

// åŠ è½½è§„åˆ™åˆ—è¡¨
async function loadRules() {
    try {
        const response = await fetch('/web/api/llm/rules');
        const data = await response.json();

        const select = document.getElementById('ruleSelect');
        select.innerHTML = '<option value="">è¯·é€‰æ‹©è¯„ä»·è§„åˆ™...</option>';

        if (data.status === 'success') {
            data.data.forEach(rule => {
                const option = document.createElement('option');
                option.value = rule.filename;
                option.textContent = rule.name;
                select.appendChild(option);
            });
        }
    } catch (error) {
        console.error('åŠ è½½è§„åˆ™åˆ—è¡¨å¤±è´¥:', error);
    }
}

// åŠ è½½æµ‹è¯„ç»“æœæ–‡ä»¶
async function loadTempResults() {
    try {
        const response = await fetch('/web/api/llm/evaluation/temp-results');
        const data = await response.json();

        const select = document.getElementById('resultFileSelect');
        select.innerHTML = '<option value="">è¯·é€‰æ‹©æµ‹è¯„ç»“æœæ–‡ä»¶...</option>';

        if (data.status === 'success') {
            data.data.forEach(file => {
                const option = document.createElement('option');
                option.value = file.filename;
                option.textContent = file.filename;
                select.appendChild(option);
            });
        }
    } catch (error) {
        console.error('åŠ è½½æµ‹è¯„ç»“æœæ–‡ä»¶å¤±è´¥:', error);
    }
}

// è¡¨å•éªŒè¯
function validateForm() {
    let isValid = false;

    if (selectedTaskType === 'test') {
        const model = document.getElementById('modelSelect').value;
        const dataset = document.getElementById('datasetSelect').value;
        isValid = model && dataset;
    } else if (selectedTaskType === 'evaluation') {
        const rule = document.getElementById('ruleSelect').value;
        const resultFile = document.getElementById('resultFileSelect').value;
        isValid = rule && resultFile;
    }

    document.getElementById('startTaskBtn').disabled = !isValid;
}

// ç›‘å¬è¡¨å•å˜åŒ–
document.addEventListener('change', function(e) {
    if (e.target.matches('select')) {
        validateForm();
    }
});

// å¼€å§‹ä»»åŠ¡
async function startTask() {
    if (!selectedTaskType) return;

    const formData = new FormData();
    formData.append('task_type', selectedTaskType);
    formData.append('max_workers', document.getElementById('maxWorkersInput').value);

    if (selectedTaskType === 'test') {
        formData.append('model_name', document.getElementById('modelSelect').value);
        formData.append('dataset_filename', document.getElementById('datasetSelect').value);
    } else if (selectedTaskType === 'evaluation') {
        formData.append('rule_filename', document.getElementById('ruleSelect').value);
        formData.append('result_filename', document.getElementById('resultFileSelect').value);
    }

    try {
        const response = await fetch('/web/api/llm/evaluation/tasks', {
            method: 'POST',
            body: formData
        });
        const data = await response.json();

        if (data.status === 'success') {
            currentTaskId = data.data.task_id;

            // éšè—åˆ›å»ºä»»åŠ¡æ¨¡æ€æ¡†
            bootstrap.Modal.getInstance(document.getElementById('createTaskModal')).hide();

            // æ˜¾ç¤ºè¿›åº¦æ¨¡æ€æ¡†
            showProgressModal();

            // å¼€å§‹è½®è¯¢è¿›åº¦
            startProgressPolling();
        } else {
            alert('åˆ›å»ºä»»åŠ¡å¤±è´¥: ' + data.message);
        }
    } catch (error) {
        console.error('åˆ›å»ºä»»åŠ¡å¤±è´¥:', error);
        alert('åˆ›å»ºä»»åŠ¡å¤±è´¥: ' + error.message);
    }
}

// æ ¼å¼åŒ–æ—¶é—´æ˜¾ç¤º
function formatTime(seconds) {
    if (seconds <= 0) return '--';

    const hours = Math.floor(seconds / 3600);
    const minutes = Math.floor((seconds % 3600) / 60);
    const secs = Math.floor(seconds % 60);

    if (hours > 0) {
        return `${hours}å°æ—¶${minutes}åˆ†é’Ÿ`;
    } else if (minutes > 0) {
        return `${minutes}åˆ†é’Ÿ${secs}ç§’`;
    } else {
        return `${secs}ç§’`;
    }
}

// æ˜¾ç¤ºè¿›åº¦æ¨¡æ€æ¡†
function showProgressModal() {
    document.getElementById('taskProgress').style.width = '0%';
    document.getElementById('progressMessage').textContent = 'ä»»åŠ¡å‡†å¤‡ä¸­...';
    document.getElementById('progressDetails').textContent = 'æ­¥éª¤: 0/0';
    document.getElementById('closeProgressBtn').disabled = true;

    new bootstrap.Modal(document.getElementById('progressModal')).show();
}

// å¼€å§‹è½®è¯¢è¿›åº¦
function startProgressPolling() {
    if (progressInterval) {
        clearInterval(progressInterval);
    }

    progressInterval = setInterval(async () => {
        try {
            const response = await fetch(`/web/api/llm/evaluation/tasks/${currentTaskId}/progress`);
            const data = await response.json();

            if (data.status === 'success') {
                updateProgress(data.data);

                if (data.data.status === 'completed' || data.data.status === 'failed') {
                    clearInterval(progressInterval);
                    document.getElementById('closeProgressBtn').disabled = false;

                    if (data.data.status === 'completed') {
                        // ä»»åŠ¡å®Œæˆï¼Œåˆ·æ–°ç»“æœè¡¨æ ¼
                        setTimeout(() => {
                            loadResultsTable();
                        }, 1000);
                    }
                }
            }
        } catch (error) {
            console.error('è·å–ä»»åŠ¡è¿›åº¦å¤±è´¥:', error);
        }
    }, 1000);
}

// æ›´æ–°è¿›åº¦
function updateProgress(progressData) {
    const progressBar = document.getElementById('taskProgress');
    const messageElement = document.getElementById('progressMessage');
    const detailsElement = document.getElementById('progressDetails');
    const estimatedTimeElement = document.getElementById('estimatedTime');
    const estimatedTimeValueElement = document.getElementById('estimatedTimeValue');

    progressBar.style.width = progressData.progress + '%';
    progressBar.textContent = progressData.progress + '%';

    messageElement.textContent = progressData.message;

    // æ˜¾ç¤ºè¯¦ç»†è¿›åº¦ä¿¡æ¯
    let detailsText = `æ­¥éª¤: ${progressData.current_step}/${progressData.total_steps}`;
    if (progressData.total_records > 0) {
        detailsText += ` | è®°å½•: ${progressData.current_record}/${progressData.total_records}`;
    }
    if (progressData.detailed_message) {
        detailsText += `<br><small class="text-muted">${progressData.detailed_message}</small>`;
    }
    detailsElement.innerHTML = detailsText;

    // æ˜¾ç¤ºé¢„ä¼°å‰©ä½™æ—¶é—´
    if (progressData.estimated_time && progressData.estimated_time > 0 && progressData.status === 'running') {
        estimatedTimeElement.style.display = 'block';
        estimatedTimeValueElement.textContent = formatTime(progressData.estimated_time);
    } else {
        estimatedTimeElement.style.display = 'none';
    }

    if (progressData.status === 'completed') {
        progressBar.classList.remove('progress-bar-striped', 'progress-bar-animated');
        progressBar.classList.add('bg-success');
        messageElement.innerHTML = `<i class="bi bi-check-circle text-success"></i> ${progressData.message}`; {# ä¿®æ”¹å›¾æ ‡ç±» #}
        if (progressData.result_file) {
            messageElement.innerHTML += `<br><small>ç»“æœæ–‡ä»¶: ${progressData.result_file}</small>`;
        }
        estimatedTimeElement.style.display = 'none';
    } else if (progressData.status === 'failed') {
        progressBar.classList.remove('progress-bar-striped', 'progress-bar-animated');
        progressBar.classList.add('bg-danger');
        messageElement.innerHTML = `<i class="bi bi-x-circle text-danger"></i> ${progressData.message}`; {# ä¿®æ”¹å›¾æ ‡ç±» #}
        if (progressData.error_message) {
            messageElement.innerHTML += `<br><small class="text-danger">${progressData.error_message}</small>`;
        }
        estimatedTimeElement.style.display = 'none';
    }
}

// å…³é—­è¿›åº¦æ¨¡æ€æ¡†
function closeProgressModal() {
    if (progressInterval) {
        clearInterval(progressInterval);
    }
    bootstrap.Modal.getInstance(document.getElementById('progressModal')).hide();
    currentTaskId = null;
}

// ä¸‹è½½æ–‡ä»¶
async function downloadFile(filename) {
    try {
        const response = await fetch(`/web/api/llm/evaluation/results/${filename}/download`);
        if (response.ok) {
            const blob = await response.blob();
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = filename;
            a.click();
            window.URL.revokeObjectURL(url);
        } else {
            alert('ä¸‹è½½å¤±è´¥');
        }
    } catch (error) {
        console.error('ä¸‹è½½å¤±è´¥:', error);
        alert('ä¸‹è½½å¤±è´¥: ' + error.message);
    }
}

// åˆ é™¤æ–‡ä»¶
async function deleteFile(filename) {
    if (!confirm(`ç¡®å®šè¦åˆ é™¤æ–‡ä»¶ "${filename}" å—ï¼Ÿ`)) {
        return;
    }

    try {
        const response = await fetch(`/web/api/llm/evaluation/results/${filename}`, {
            method: 'DELETE'
        });
        const data = await response.json();

        if (data.status === 'success') {
            alert('æ–‡ä»¶åˆ é™¤æˆåŠŸ');
            loadResultsTable();
        } else {
            alert('åˆ é™¤å¤±è´¥: ' + data.message);
        }
    } catch (error) {
        console.error('åˆ é™¤å¤±è´¥:', error);
        alert('åˆ é™¤å¤±è´¥: ' + error.message);
    }
}
</script>
{% endblock %}
